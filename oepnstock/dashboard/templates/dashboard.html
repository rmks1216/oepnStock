<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆ oepnStock ìë™ë§¤ë§¤ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- JavaScript -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <style>
        .metric-card {
            transition: transform 0.2s ease-in-out, shadow 0.2s ease-in-out;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-safe { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-danger { background-color: #ef4444; }
        
        .live-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-3xl font-bold text-gray-900">
                        ğŸ“ˆ oepnStock ìë™ë§¤ë§¤
                    </h1>
                    <div class="flex items-center">
                        <span class="status-indicator live-indicator" id="connection-status"></span>
                        <span class="text-sm text-gray-600" id="connection-text">ì—°ê²° ì¤‘...</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="status-indicator" id="risk-indicator"></span>
                        <span class="text-sm font-medium" id="risk-level">ì•ˆì „</span>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="pause-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-pause mr-1"></i> ì¼ì‹œì •ì§€
                        </button>
                        <button id="resume-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hidden">
                            <i class="fas fa-play mr-1"></i> ì¬ê°œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- ì¼ì¼ ìˆ˜ìµë¥  -->
            <div class="metric-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">ì¼ì¼ ìˆ˜ìµë¥ </p>
                        <p class="text-3xl font-bold mt-2" id="daily-return">0.00%</p>
                        <p class="text-sm mt-1" id="daily-pnl">0ì›</p>
                    </div>
                    <div class="text-4xl" id="daily-return-icon">ğŸ“Š</div>
                </div>
            </div>
            
            <!-- ì›”ê°„ ìˆ˜ìµë¥  -->
            <div class="metric-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm font-medium">ì›”ê°„ ìˆ˜ìµë¥ </p>
                        <p class="text-3xl font-bold mt-2" id="monthly-return">0.00%</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                 id="monthly-progress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ëª©í‘œ: 2.5%</p>
                    </div>
                    <div class="text-4xl">ğŸ“ˆ</div>
                </div>
            </div>
            
            <!-- í˜„ì¬ í¬ì§€ì…˜ -->
            <div class="metric-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">í˜„ì¬ í¬ì§€ì…˜</p>
                        <p class="text-3xl font-bold mt-2">
                            <span id="current-positions">0</span>/<span id="max-positions">5</span>
                        </p>
                        <p class="text-sm text-gray-600 mt-1">ìŠ¹ë¥ : <span id="win-rate">0%</span></p>
                    </div>
                    <div class="text-4xl">ğŸ¯</div>
                </div>
            </div>
            
            <!-- í˜„ì¬ ìë³¸ -->
            <div class="metric-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">í˜„ì¬ ìë³¸</p>
                        <p class="text-3xl font-bold mt-2" id="current-capital">â‚©0</p>
                        <p class="text-sm text-gray-600 mt-1">Market Score: <span id="market-score">0</span></p>
                    </div>
                    <div class="text-4xl">ğŸ’°</div>
                </div>
            </div>
            
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- ìì‚° ê³¡ì„  -->
            <div class="chart-container">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-green-500"></i>
                    ìì‚° ê³¡ì„ 
                </h2>
                <div id="equity-chart" style="height: 400px;"></div>
            </div>
            
            <!-- ì¼ì¼ ìˆ˜ìµë¥  -->
            <div class="chart-container">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-blue-500"></i>
                    ì¼ì¼ ìˆ˜ìµë¥ 
                </h2>
                <div id="daily-returns-chart" style="height: 400px;"></div>
            </div>
            
        </div>

        <!-- í•˜ë‹¨ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- í˜„ì¬ í¬ì§€ì…˜ -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-briefcase mr-2 text-purple-500"></i>
                    í˜„ì¬ í¬ì§€ì…˜
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">ì¢…ëª©</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-700">ìˆ˜ëŸ‰</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-700">í‰ê· ë‹¨ê°€</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-700">í˜„ì¬ê°€</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-700">í‰ê°€ì†ìµ</th>
                                <th class="px-4 py-3 text-right font-medium text-gray-700">ìˆ˜ìµë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="positions-table" class="divide-y divide-gray-200">
                            <!-- í¬ì§€ì…˜ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ìµœê·¼ ì•Œë¦¼ -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-bell mr-2 text-orange-500"></i>
                    ìµœê·¼ ì•Œë¦¼
                </h2>
                <div id="alerts-list" class="space-y-3">
                    <!-- ì•Œë¦¼ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
        </div>

        <!-- ì¶”ê°€ ì°¨íŠ¸ - ë“œë¡œë‹¤ìš´ -->
        <div class="mt-8">
            <div class="chart-container">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-area mr-2 text-red-500"></i>
                    ë“œë¡œë‹¤ìš´ ë¶„ì„
                </h2>
                <div id="drawdown-chart" style="height: 300px;"></div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <p class="text-gray-500 text-sm">
                    Â© 2024 oepnStock ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ
                </p>
                <p class="text-gray-500 text-sm" id="last-updated">
                    ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="update-timestamp">--</span>
                </p>
            </div>
        </div>
    </footer>

    <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <script>
        // Socket.IO ì—°ê²°
        const socket = io();
        
        // ì „ì—­ ë³€ìˆ˜
        let isConnected = false;
        let lastUpdateTime = null;
        
        // DOM ìš”ì†Œë“¤
        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            connectionText: document.getElementById('connection-text'),
            riskIndicator: document.getElementById('risk-indicator'),
            riskLevel: document.getElementById('risk-level'),
            dailyReturn: document.getElementById('daily-return'),
            dailyPnl: document.getElementById('daily-pnl'),
            dailyReturnIcon: document.getElementById('daily-return-icon'),
            monthlyReturn: document.getElementById('monthly-return'),
            monthlyProgress: document.getElementById('monthly-progress'),
            currentPositions: document.getElementById('current-positions'),
            maxPositions: document.getElementById('max-positions'),
            winRate: document.getElementById('win-rate'),
            currentCapital: document.getElementById('current-capital'),
            marketScore: document.getElementById('market-score'),
            positionsTable: document.getElementById('positions-table'),
            alertsList: document.getElementById('alerts-list'),
            updateTimestamp: document.getElementById('update-timestamp'),
            pauseBtn: document.getElementById('pause-btn'),
            resumeBtn: document.getElementById('resume-btn')
        };

        // Socket.IO ì´ë²¤íŠ¸
        socket.on('connect', function() {
            console.log('Connected to server');
            isConnected = true;
            updateConnectionStatus(true);
            socket.emit('request_live_data');
            loadInitialData();
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            isConnected = false;
            updateConnectionStatus(false);
        });

        socket.on('live_update', function(data) {
            console.log('Live update received:', data);
            updateDashboard(data);
            lastUpdateTime = new Date(data.timestamp);
            updateTimestamp();
        });

        socket.on('alert_notification', function(alert) {
            console.log('Alert notification:', alert);
            showToast(alert);
            updateAlertsList();
        });

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            if (connected) {
                elements.connectionStatus.className = 'status-indicator status-safe live-indicator';
                elements.connectionText.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            } else {
                elements.connectionStatus.className = 'status-indicator status-danger';
                elements.connectionText.textContent = 'ì—°ê²° ëŠì–´ì§';
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard(data) {
            // ì¼ì¼ ìˆ˜ìµë¥ 
            const dailyReturn = data.daily_return || 0;
            elements.dailyReturn.textContent = (dailyReturn * 100).toFixed(2) + '%';
            elements.dailyReturn.className = `text-3xl font-bold mt-2 ${
                dailyReturn > 0 ? 'text-green-600' : 
                dailyReturn < 0 ? 'text-red-600' : 'text-gray-800'
            }`;
            
            // ì¼ì¼ ì†ìµ
            const dailyPnl = data.daily_pnl || 0;
            elements.dailyPnl.textContent = formatCurrency(dailyPnl);
            elements.dailyPnl.className = `text-sm mt-1 ${
                dailyPnl > 0 ? 'text-green-600' : 
                dailyPnl < 0 ? 'text-red-600' : 'text-gray-600'
            }`;
            
            // ì•„ì´ì½˜ ë³€ê²½
            elements.dailyReturnIcon.textContent = dailyReturn > 0 ? 'ğŸ“ˆ' : 
                                                  dailyReturn < 0 ? 'ğŸ“‰' : 'ğŸ“Š';
            
            // ì›”ê°„ ìˆ˜ìµë¥ 
            const monthlyReturn = data.monthly_return || 0;
            elements.monthlyReturn.textContent = (monthlyReturn * 100).toFixed(2) + '%';
            elements.monthlyReturn.className = `text-3xl font-bold mt-2 ${
                monthlyReturn > 0 ? 'text-green-600' : 
                monthlyReturn < 0 ? 'text-red-600' : 'text-gray-800'
            }`;
            
            // ì›”ê°„ ì§„í–‰ë¥  (ëª©í‘œ 2.5% ê¸°ì¤€)
            const monthlyProgress = Math.min((Math.abs(monthlyReturn) / 0.025) * 100, 100);
            elements.monthlyProgress.style.width = monthlyProgress + '%';
            elements.monthlyProgress.className = `h-2 rounded-full transition-all duration-300 ${
                monthlyReturn >= 0.025 ? 'bg-green-500' :
                monthlyReturn >= 0.015 ? 'bg-yellow-500' : 'bg-blue-600'
            }`;
            
            // í¬ì§€ì…˜
            elements.currentPositions.textContent = data.positions_count || 0;
            elements.winRate.textContent = ((data.win_rate || 0) * 100).toFixed(1) + '%';
            
            // ìë³¸
            elements.currentCapital.textContent = formatCurrency(data.current_capital || 0);
            elements.marketScore.textContent = data.market_score || 0;
            
            // ë¦¬ìŠ¤í¬ ë ˆë²¨
            const riskLevel = data.risk_level || 'ì•ˆì „';
            elements.riskLevel.textContent = riskLevel;
            
            // ë¦¬ìŠ¤í¬ ì¸ë””ì¼€ì´í„°
            let riskClass = 'status-safe';
            if (riskLevel === 'ì£¼ì˜') riskClass = 'status-warning';
            else if (riskLevel === 'ìœ„í—˜') riskClass = 'status-danger';
            
            elements.riskIndicator.className = `status-indicator ${riskClass}`;
            
            // ê±°ë˜ í™œì„± ìƒíƒœ
            updateTradingButtons(data.is_trading_active);
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function loadInitialData() {
            try {
                // ê°œìš” ë°ì´í„° ë¡œë“œ
                const response = await fetch('/api/overview');
                const data = await response.json();
                updateDashboard(data);
                
                // ì°¨íŠ¸ ë¡œë“œ
                loadCharts();
                
                // í¬ì§€ì…˜ ë° ì•Œë¦¼ ë¡œë“œ
                loadPositions();
                updateAlertsList();
                
            } catch (error) {
                console.error('Failed to load initial data:', error);
                showToast({
                    level: 'ERROR',
                    title: 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨',
                    message: 'ì´ˆê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
                });
            }
        }

        // ì°¨íŠ¸ ë¡œë“œ
        async function loadCharts() {
            try {
                // ìì‚° ê³¡ì„ 
                const equityResponse = await fetch('/api/chart/equity');
                const equityData = await equityResponse.json();
                Plotly.plot('equity-chart', equityData.data, equityData.layout, {responsive: true});
                
                // ì¼ì¼ ìˆ˜ìµë¥ 
                const returnsResponse = await fetch('/api/chart/daily-returns');
                const returnsData = await returnsResponse.json();
                Plotly.plot('daily-returns-chart', returnsData.data, returnsData.layout, {responsive: true});
                
                // ë“œë¡œë‹¤ìš´
                const drawdownResponse = await fetch('/api/chart/drawdown');
                const drawdownData = await drawdownResponse.json();
                Plotly.plot('drawdown-chart', drawdownData.data, drawdownData.layout, {responsive: true});
                
            } catch (error) {
                console.error('Failed to load charts:', error);
            }
        }

        // í¬ì§€ì…˜ ë¡œë“œ
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions');
                const positions = await response.json();
                
                elements.positionsTable.innerHTML = '';
                
                if (positions.length === 0) {
                    elements.positionsTable.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                í˜„ì¬ ë³´ìœ  í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                positions.forEach(position => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const pnlClass = position.unrealized_pnl > 0 ? 'text-green-600' : 
                                    position.unrealized_pnl < 0 ? 'text-red-600' : 'text-gray-600';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium">${position.symbol}</td>
                        <td class="px-4 py-3 text-right">${position.quantity.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right">${position.avg_price.toLocaleString()}ì›</td>
                        <td class="px-4 py-3 text-right">${position.current_price.toLocaleString()}ì›</td>
                        <td class="px-4 py-3 text-right ${pnlClass}">${formatCurrency(position.unrealized_pnl)}</td>
                        <td class="px-4 py-3 text-right ${pnlClass}">${(position.unrealized_pnl_pct * 100).toFixed(2)}%</td>
                    `;
                    
                    elements.positionsTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Failed to load positions:', error);
            }
        }

        // ì•Œë¦¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        async function updateAlertsList() {
            try {
                const response = await fetch('/api/alerts/recent?limit=5');
                const alerts = await response.json();
                
                elements.alertsList.innerHTML = '';
                
                if (alerts.length === 0) {
                    elements.alertsList.innerHTML = `
                        <p class="text-gray-500 text-sm text-center py-4">ìµœê·¼ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    `;
                    return;
                }
                
                alerts.forEach(alert => {
                    const alertElement = createAlertElement(alert);
                    elements.alertsList.appendChild(alertElement);
                });
                
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        // ì•Œë¦¼ ìš”ì†Œ ìƒì„±
        function createAlertElement(alert) {
            const div = document.createElement('div');
            div.className = `p-3 border-l-4 rounded-r-lg ${getAlertStyles(alert.level)}`;
            
            const time = new Date(alert.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <p class="font-medium text-sm">${alert.title}</p>
                        <p class="text-xs text-gray-600 mt-1">${alert.message}</p>
                    </div>
                    <span class="text-xs text-gray-500 ml-2">${time}</span>
                </div>
            `;
            
            return div;
        }

        // ì•Œë¦¼ ìŠ¤íƒ€ì¼
        function getAlertStyles(level) {
            switch (level) {
                case 'EMERGENCY':
                    return 'border-red-500 bg-red-50';
                case 'WARNING':
                    return 'border-yellow-500 bg-yellow-50';
                case 'SUCCESS':
                    return 'border-green-500 bg-green-50';
                default:
                    return 'border-blue-500 bg-blue-50';
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(alert) {
            const toast = document.createElement('div');
            toast.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-full`;
            
            const bgClass = alert.level === 'EMERGENCY' ? 'bg-red-500' :
                           alert.level === 'WARNING' ? 'bg-yellow-500' :
                           alert.level === 'SUCCESS' ? 'bg-green-500' : 'bg-blue-500';
            
            toast.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-2 h-2 ${bgClass} rounded-full"></div>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium text-gray-900">${alert.title}</p>
                            <p class="mt-1 text-sm text-gray-500">${alert.message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button class="toast-close bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // ë‹«ê¸° ë²„íŠ¼
            toast.querySelector('.toast-close').onclick = () => removeToast(toast);
            
            // ìë™ ì œê±° (5ì´ˆ)
            setTimeout(() => removeToast(toast), 5000);
        }

        // í† ìŠ¤íŠ¸ ì œê±°
        function removeToast(toast) {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        // ê±°ë˜ ì œì–´ ë²„íŠ¼
        function updateTradingButtons(isActive) {
            if (isActive) {
                elements.pauseBtn.classList.remove('hidden');
                elements.resumeBtn.classList.add('hidden');
            } else {
                elements.pauseBtn.classList.add('hidden');
                elements.resumeBtn.classList.remove('hidden');
            }
        }

        // ê±°ë˜ ì¼ì‹œì •ì§€
        elements.pauseBtn.onclick = async function() {
            try {
                const duration = prompt('ì¼ì‹œì •ì§€ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì‹œê°„)', '1');
                if (!duration) return;
                
                const response = await fetch('/api/control/pause', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: parseInt(duration) })
                });
                
                const result = await response.json();
                if (result.status === 'paused') {
                    showToast({
                        level: 'WARNING',
                        title: 'ê±°ë˜ ì¼ì‹œì •ì§€',
                        message: `ê±°ë˜ê°€ ${duration}ì‹œê°„ ë™ì•ˆ ì¤‘ë‹¨ë©ë‹ˆë‹¤.`
                    });
                    updateTradingButtons(false);
                }
            } catch (error) {
                console.error('Failed to pause trading:', error);
            }
        };

        // ê±°ë˜ ì¬ê°œ
        elements.resumeBtn.onclick = async function() {
            try {
                const response = await fetch('/api/control/resume', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.status === 'resumed') {
                    showToast({
                        level: 'SUCCESS',
                        title: 'ê±°ë˜ ì¬ê°œ',
                        message: 'ê±°ë˜ê°€ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.'
                    });
                    updateTradingButtons(true);
                }
            } catch (error) {
                console.error('Failed to resume trading:', error);
            }
        };

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatCurrency(value) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(value);
        }

        function updateTimestamp() {
            if (lastUpdateTime) {
                elements.updateTimestamp.textContent = lastUpdateTime.toLocaleTimeString('ko-KR');
            }
        }

        // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            if (isConnected) {
                loadPositions();
                updateAlertsList();
            }
        }, 30000);

        // ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
        window.addEventListener('resize', () => {
            Plotly.Plots.resize('equity-chart');
            Plotly.Plots.resize('daily-returns-chart');
            Plotly.Plots.resize('drawdown-chart');
        });

    </script>
</body>
</html>